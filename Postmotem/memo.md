## 前提

この文章はインシデント(障害や緊急対応など)発生時の対応関するポストモーテムに関して記述する。

プロジェクト終了時などその他のタイミングで行うポストモーテムとは異なる。

## 用語

- ポストモーテム
    - この文章ないではインシデント時に作成するドキュメントをポストモーテムと呼ぶ
    - ドキュメントとそれにまつわるレビューやなど仕組みをまとめて表す場合はポストモーテムのプロセスと呼称する
- インシデント
    - 障害・緊急対応などサービスに何かが起きた時の呼称
- トイル(SRE本 p51)
    - プロダクションサービスを動作させることに関係する作業で以下のような傾向を持つもの
        - 手作業で繰り返し行われる
        - 自動化することが可能である
        - 戦術的で長期的な価値を持たない
        - 作業量がサービスの成長に比例する

## ポストモーテムの目的

<details><summary>参考文献</summary>

https://postmortems.pagerduty.com/what_is/
 
> A postmortem (or post-mortem) is a process intended to help you learn from past incidents. It typically involves a blame-free analysis and discussion soon after an event has taken place. An artifact is produced that includes a detailed description of exactly what went wrong in order to cause the incident, along with a list of steps to take in order to prevent a similar incident from occurring again in the future. An analysis of how effective your incident response process itself was during the incident should also be included in the discussion. The value of postmortems comes from helping institutionalize a culture of continuous improvement.

SRE本 p175

> ポストモーテムを書くことの主な目的は、インシデントがドキュメント化されること、影響を及ばしたすべての根本原因(群)が十分に理解されること、そしてとりわけ、再発の可能性や影響を削減するための効果的な予防策が確実に導入されるようにすることです


</details>

過去のインシデントから学習し、再発の可能性や影響を削減するために行われる。

具体的には以下のような事を目的となる。

- 根本原因が十分(具体的・広範囲に)に理解されること
- 効果的な予防策が確実に導入される事

## ポストモーテムのプロセス

<details><summary>参考文献</summary>

https://postmortems.pagerduty.com/what_is/

> Organizations may refer to the postmortem process in slightly different terms:
> 
> - Learning Review
> - After-Action Review
> - Incident Review
> - Incident Report
> - Post-Incident Review
> - Root Cause Analysis (or RCA)

</details>

### インシデント発生後の対応

- ポストモーテムの作成
    - 担当者明確化
    - 現在のステータス
    - 概要
    - 原因分析
        - 根本原因(e.g. ○○のバグのため)
        - 発生原因(e.g. △△の操作を行ったため)
    - 対応内容
    - 対応自体の分析
    - 教訓
    - 今後のアクションリスト
        - 事後対応内容
        - 担当者
        - 優先度
- レビュー
    - レビューMTGの実施
- 共有
    - ステークホルダーへの共有
    - なるべく広範囲への共有
- ポストモーテムのリポジトリへの保存

### ポストモーテムを書くために必要な準備

- ポストモーテム作成ルール
    - どのような時にポストモーテムを書く必要があるか
    - どのような内容を記載するか
        - テンプレート
        - チェックリスト
- インシデント時の情報収集方法
    - 原因分析・事後分析に必須
- ポストモーテムレビューの仕組み
    - 確実にレビューされる
    - レビューMTGの実施
    - レビュー観点・チェックリスト
- 共有方法
- リポジトリの準備
    - ステータス管理
- ポストモーテム(プロセス)文化の導入
    - 上位者への理解
    - ポストモーテムプロセスのため時間の確保
    - 非難のないポストモーテム文化
- +α
    - 再発防止のための学習方法
    - ポストモーテムプロセス自体の見直し
        - 過剰なトイルが発生していないか


## ポストモーテム行うために必要な検討事項

### ドキュメント作成ルール

<details><summary>参考文献</summary>

SRE本 p176

> - ユーザーに影響が及んだダウンタイムやデグレデーションが一定の閾値を超えた場合
> - 種類の如何を問わず、データの損失が生じた場合
> - オンコールエンジニアの介入が必要だった場合(リリースのロールバック、トラフィックのルート調整など)
> - 解決までの時間が一定の閾値を超えた場合
> - モニタリングの障害(これは通常、人手でインシデントが発見されることになります)

> ポストモーテムの条件はインシデントが生じる前に定義しておき、ポストモーテムが必要かを誰もが理解できるようにしておくことが重要です。
> こういった客観的な条件に加えて、イベントに関わりのあるステークホルダーはポストモーテムを求めることができます。

</details>

- 事前に決めた条件に則り、条件を満たす場合に作成する
    - e.g. ユーザー影響あるダウンタイムの発生
    - e.g. エンジニアが介入が必要だったとき
    - e.g. 解決までの時間
    - e.g. データの損失が発生した場合
    - e.g. 支払い、請求などお金に関わる問題発生時
    - e.g. モニタリングシステム自体の障害
- 上記の決まった条件以外で問題となったイベントのステークホルダーは条件に以外で求める事ができる

### ツールの選定

<details><summary>参考文献</summary>

SRE本 p177

> リアルタイムコラボレーション
>     リアルタイムコラボレーション機能があれば、データや着想を素早く集められるようになります。ポストモーテムの作成初期には欠かせません。
> 
> オープンなコメント/アノテーションシステム
>     ソリューションに関する衆知を集めることを容易にし、カバーする範囲を広げてくれます。
>
> メールによる通知
>     ドキュメント内に記載されている協力者たちに通知を送ったり、情報やフィードバックを提供してもらいたい人たちを招待できます。

</details>

- ポストモーテムを書くためには以下の機能を備えているツールが望ましい
    - リアルタイムコラボレーション
    - オープンなコメント/アノテーションシステム
    - メール、チャットによる自動通知
- 管理システム 
    - リポジトリ
        - ステータスの管理が可能
    - SRE本では以下のようなツールが載っている
        - https://github.com/etsy/morgue (最近は更新されていない)

### レビューを必ず行うための仕組み

<details><summary>参考文献</summary>

SRE本 p178

> ポストモーテムを書くことには、正式なレビューと公表も含まれます。

> 以下のようなことがレビューの対象となります。
>   - 後々のためにインシデントの主要なデータは収集されたか?
>   - インパクトの分析は完全か?
>   - 根本原因は十分に深く分析されているか?
>   - アクションプランは適切で、その結果として行われたバグの修正には適切な優先順位が与えられているか?
>   - 結果は関係するステークホルダーたちと共有されたか?

SRE本 p178

> レビューされていないポストモーテムは、存在しなかったも同然です。完成した下書きが確実にレビューされるようにするために、私たちはポストモーテムのための定期的なレビューセッションを推奨しています。そういったミーティングにおいては、進行中の議論やコメントを締めくくり、着想を記録し、状況を最終的にとりまとめることが重要です。

> 関係者全員が、ポストモーテムのドキュメントとそのアクションアイテムに満足したら、そのポストモーテムを過去のインシデントについてのチームや組織のリポジトリに追加します

</details>

- どのタイミングでレビューをするか
    - e.g. 担当者がポストモーテムを書いたら関係者によるレビューを行う
    - e.g. 事前に上位リーダーが内容確認後に関係者レビューを行うなど
- レビューされていないポストモーテムが存在しない仕組みづくり
    - レビューMTGを行いポストモーテムを完成させる
    - レビューMTGの議論内容をとりまとめ、ポストモーテムに記載する

### 共有方法と最低限の共有範囲

<details><summary>参考文献</summary>

SRE本 p178

> ポストモーテムの知識や教訓が役立つような、できる限り広範囲の対象とポストモーテムを共有することを目標としています。

</details>

ポストモーテムの知識・教訓が役立つよう、可能な限り広範囲へ共有される事を目標とする。

### ポストモーテムプロセスのフィードバック方法とタイミング

<details><summary>参考文献</summary>

SRE本 p180

> ポストモーテムのプロセスがその目標の達成に向けたものになっているか、そしてそのプロセスを改善できないかを、定期的にチームで調査しています。
> 私たちは、次のような問いかけをします。
> 
> - ポストモーテムの文化は仕事を支援できているか? 
> - ポストモーテムを書くことによって、トイル(5章参照)が増えすぎていないか? 
> - 自分のチームから他のチームに推薦できるベストプラクティスにはどんなものがあるか?
> - 開発してほしいツールにはどんなものがあるか? 
> 
> この調査は、ポストモーテム文化の効率を高める改善を現場のSREが求める機会を提供するものなのです。

</details>

ポストモーテムのプロセス自体に無駄がないかを見直し、改善を行う。
- ポストモーテムは業務の支援となっているか？
- トイルが発生しすぎていないか？
- ツールは適切か？新しい開発が必要か?


### 将来的な価値を考える

<details><summary>参考文献</summary>

SRE本 P181

> 私たちは最近ポストモーテムのテンプレート(付録D参照)にメタデータのフィールドを追加しました。この領域の将来の作業としては、機械学習による弱点の予測の支援、リアルタイムのインシデント調査の促進、インシデントの再発の削減があります。

</details>

## ポストモーテム文化の導入

<details><summary>参考文献</summary>

SRE本 p179

> ポストモーテムの文化を組織に導入することは、言うほど簡単なことではありません。
> そのためには、継続的な育成と強化が必要になります。
> 私たちは、協調的なポストモーテムの文化をレビューへの上級管理職の積極的な参加やコラボレーションのプロセスを通じて強化しています。

> 非難のないポストモーテムは、理想的にはエンジニアが自発的に生み出すものであるべきです。

> ポストモーテムを育む精神の下で、SREはシステムのインフラストラクチャについて学んだことを広める活動を積極的に作り出します。
> 以下は、そういった活動の例です。

> 今月のポストモーテム
>   月刊のニュースレターで、うまく書かれた興味深いポストモーテムを組織全体で共有します。
> 
> Google+ ポストモーテムグループ
>   内外のポストモーテム、ベストプラクティス、ポストモーテムへのコメントの共有と議論のためのグループです。
> 
> ポストモーテム読書会
>   定期的なポストモーテムの読書会を開催するチームで、興味深いポストモーテムや、影響の大きいポストモーテムを(美味しい軽食と共に)取り上げます。これは参加者、非参加者、新人のGooglerたちのオープンな対話の場であり、起きたこと、インシデントが残した教訓、インシデントの余波などについて語り合います。レビューの対象となるポストモーテムは、数ヶ月、あるいは数年前のものであることもよくあります!
> 
> 不運の輪
>   新人SREは、しばしば不運の輪というトレーニングを受けることになります(「28.4.2ディザスタロールプレイング」参照)。このトレーニングでは、ポストモーテムに書かれている役割をエンジニアたちに演じてもらって過去のポストモーテムの再現をします。当時のインシデント指揮者は、このトレーニングをできる限り「リアル」にするために出席します。

</details>

### 非難なく行う

<details><summary>参考文献</summary>

SRE本 P176

> Googleの弾力性を全体として高めるための機会としても見なされています。非難のないポストモーテムは、指弾をすることでフラストレーションを発散するものではなく、サービスのどの部分をどうすれば改善できるのかを提起するものでなければならないのです。

SRE本 P177

> 難的な雰囲気はインシデントや問題を隠蔽する文化を醸成する危険性をはらんでおり、ひいては組織にとってのより大きなリスクへとつながりかねません

</details>

ポストモーテムの記述・レビューなど全てのプロセスを通して、非難なく行うことが重要である
- 避難的な雰囲気は問題の隠蔽へつながる
- ポストモーテムを頻繁に作成している事を非難しない
- ポストモーテムはサービス改善のための提案である
- ポストモーテムの作成を称賛する文化を作る事が望ましい


### 継続的な育成と強化

継続にはポストモーテム文化の育成と強化が必要となる。
- 上位管理職の積極的な参加
- 積極的な情報の発信
    - よいポストモーテムの選出・定期的な発信
- 公開されたポストモーテム議論の場
    - チャットチャンネル、メールグループなど
- ポストモーテムの読書会
    - 過去の興味深いポストモーテムの振り返り
    - 新旧を問わず
- ディザスターロールプレイング
    - ポストモーテムに書かれている役割をエンジニアたちが演じ、過去のポストモーテムの再現する


### 準備コストと価値に対する理解

<details><summary>参考文献</summary>

SRE本 P179

> ポストモーテムを組織に導入する上での最も大きな課題は、準備にかかるコストほどの価値があるのかを疑問に思う人がいるかもしれないことです。
> この課題に対しては、以下のような対策が役立つでしょう。
> 
> ● ポストモーテムをワークフローに落とし込む。
>     試行期間にいくつかのポストモーテムがうまくできあがれば、その価値を証明しやすくなり、ポストモーテムを行う条件も特定しやすくなるでしょう。
> 
> ● 効果的なポストモーテムを書くことは報われることであり、賞賛されることであるようにする。
>     これには、すでに述べたようなソーシャルな方法を通じて公的に行うことも、個人やチームのパフォーマンス管理を通じて行うことも含まれます。
> 
> ● 上位のリーダーたちの承認と参加を奨励する。
>     ポストモーテムの価値が高いことについては、Larry Pageまでが語っているのです!

</details>

ポストモーテム文化を組織に導入する上での最大の課題は、準備コストよりも価値があるのか？と考える人が多いかもしれないこと。

これを解決するには以下のような対策が考えられる
- ワークフローに落とし込む
- よいポストモーテムを書くことは評価されるように
    - ピアボーナスを用意してもよい
- 上位のリーダーたちの承認と参加を奨励する

理解に関しては
- ポストモーテムプロセスのフィードバックを行う
- 継続的な育成と強化
- 将来的な価値を考える

などと合わせて考えることが理解を得る助けとなる

## ポストモーテムの例

SRE本 p507

<details>

### Shakespeare Sonnet++ ポストモーテム(インシデント番号465)

- 作成日:2015-10-21
- 作者:jennifer,martym,agoogler
- ステータス:完了,アクションアイテムは対応中
- サマリ:新しいソネットが発見されたことによって急激にシェークスピアへの関心が高まった期間に、シェークスピア検索が66分間にわたってダウンした。
- インパクト:推定12.1億のクエリがロスト、収益への影響なし。
- 根本原因:異常に高い負荷と、検索語句がシェークスピアのコーパスにないことによって検索が失敗した場合に生じるリソースリークが重なったことによるカスケード障害。新たに発見されたソネットにはこれまでのシェークスピアのいずれの作品でも使われていなかった単語が使われており、ユーザーはその単語を検索した。通常の状況下では、リソースリークによるタスク障害の発生頻度は気づかれない程度の低さである。
- 発生要因:トラフィックの突然の増加によって表面化した潜在バグ。
- 対応:トラフィックを犠牲となるクラスタへ流し、カスケード障害の緩和のために10倍のキャパシティを追加した。更新されたインデックスをデプロイし、潜在バグの影響が生じないようにした。追加のキャパシティは、新しいソネットに対する世間の関心の高まりが落ち着くまで保持する。リソースリークは特定され、修正がデプロイされた。検出:BorgmonがHTTP 500が大量に生じていることを検出し、オンコールをページした。
- アクションアイテム:
    | アクションアイテム                                                                                                                             | 種類     | 担当     | バグ             |
----|------------------------------------------------------------------------------------------------------------------------------------------------|----------|----------|------------------|
    | 手順書のカスケード障害への対応方法を更新する                                                                                                   | 緩和     | jennifer | n/a DONE         |
    | flux capacitorを使ってクラスタ間のバランスを取る                                                                                               | 回避     | martym   | バグ5554823 TODO |
    | 次回のDiRTにカスケード障害のテストを計画する                                                                                                   | プロセス | docbrown | n/a TODO         |
    | インデックスMR/fusionの動作の調査の継続                                                                                                        | 回避     | jennifer | バグ5554824 TODO |
    | 検索ランキングサブシステムへのファイルディスクリプタリークへの対応の組み込み                                                                   | 回避     | agoogler | バグ5554825 DONE |
    | シェークスピア検索へのロードシェディング機能の追加                                                                                             | 回避     | agoogler | バグ5554826 TODO |
    | 死のクエリに対してサーバーが正しく返信することを確認するための回帰テストの構築                                                                 | 回避     | clarac   | バグ5554827 TODO |
    | プロダクション環境への更新された検索ランキングサブシステムのデプロイ                                                                           | 回避     | jennifer | n/a DONE         |
    | エラーバジェットが枯渇したため2015年11月20日までプロダクション環境を凍結する。グロテスクで信じがたい奇妙で前代未聞の状況が見つかった場合を除く | その他   | docbrown | n/a TODO         |

#### 教訓

##### うまくいったこと

- 高頻度のHTTP 500の発生(100%に達しかかっていた)をモニタリングシステムがすぐに通知したこと。
- 更新されたシェークスピアのコーパスを全クラスタに素早く展開できたこと。

##### うまくいかなかったこと

- カスケード障害へ対応方法が手元になかったこと。
- きわめて例外的なトラフィックの増大によって、可用性のエラーバジェットを(数桁にもわたって)超えてしまったこと。それらのトラフィックの処理は、ほぼすべて失敗した。

##### 幸運だったこと

(このセクションには本当にニアミスだったことを記述します)

- シェークスピア愛好者のメーリングリストに新たなソネットが投稿されていたこと。
- サーバーのログに、クラッシュの原因としてファイルディスクリプタの枯渇を指すスタックトレースがでていたこと。
- 頻繁に検索される語を含む新しいインデックスをプッシュすることで、死のクエリの問題が解決できたこと。


##### タイムライン

(インシデントの「台本」。ポストモーテムのタイムラインは、まずインシデント管理ドキュメントのインシデントタイムラインを使って記述し、その後他の関連するエントリで補足してください。)

2015-10-21(時刻はすべてUTC)

- 14:51 デロリアンの小物入れから新たなシェークスピアのソネットが発見されたことがニュースで報じられた。
- 14:53 新しいソネットを探す場所としてシェークスピア検索がRedditの/r/shakespeareへのポストで示された(ただし我々はまだそのソネットを未入手)後、シェークスピア検索へのトラフィックが88倍になった。
- 14:54 障害の始まり ―検索のバックエンドが負荷でメルトダウンし始めた。
- 14:55 docbrownはページストームを受信し始めた。内容は全クラスタでのManyHttp500s。
- 14:57 シ ェ ー クスピア検索へのすべてのトラフ ィ ッ クが失敗している状況。http://monitor/shakespeare?end_time=20151021T145700を参照。
- 14:58 docbrownが調査を開始。バックエンドのクラッシュレートがきわめて高くなっていることを発見。
- 15:01 インシデントとして対応開始。docbrownは、カスケード障害によりインシデント番号465を宣言。調整を#shakespeareで行い、jenniferをインシデント指揮者に指名。
- 15:02 たまたま誰かがソネットの発見に関するメールをshakespeare-discuss@に送信しており、それがmartymのメールボックスの先頭にあった。
- 15:03 jenniferがインシデントについてshakespeare-incidents@リストに連絡。
- 15:04 martymが新しいソネットのテキストを見つけ、コーパスの更新に関するドキュメントを探し始める。
- 15:06 docbrownが全クラスタの全タスクに共通のクラッシュの症状を発見。アプリケーションのログから原因の調査を開始。
- 15:07 martymがドキュメンテーションを発見。コーパスの更新の準備作業を開始。
- 15:10 martymが新しいソネットをシェークスピアの既知の作品に追加。インデックス作成ジョブを起動。
- 15:12 docbrownはclaracとagoogler(シェークスピア開発チーム)にコンタクトし、原因の可能性があるコードベースの調査への協力を依頼。
- 15:18 claracがファイルディスクリプタの枯渇を示す決定的な証拠をログから発見。単語が検索対象のコーパスにない場合にリークが生じるコードがあることを確認。
- 15:20 martymのインデックス作成MapReduceジョブが完了。
- 15:21 jenniferとdocbrownは、インスタンスが死んで再起動されるまでに十分な処理ができる程度にインスタンスの負荷を下げるために、インスタンス数を十分に増やすことを決定。
- 15:23 docbrownは、他のクラスタで増やされたインスタンスがすぐに死んでしまうことがないように、すべてのトラフィックがUSA-2クラスタに送られるようロードバランサーを設定。
- 15:25 martymが新しいインデックスを全クラスタにレプリケーション開始。
- 15:28 docbrownがインスタンス数を2倍にし始める。
- 15:32 jenniferがロードバランシングを変更し、トラフィックをUSA-2以外のクラスタに流し始める。
- 15:33 USA-2以外のクラスタでのタスクが障害を起こし始める。以前と同じ症状。
- 15:34 ホワイトボードに書かれた増やすインスタンス数の計算にケタの間違いを発見。
- 15:36 jenniferはグローバルで5倍にインスタンス数を増やす(合計で最初のキャパシティの10倍)準備をするため、ロードバランシングを戻して再度USA-2クラスタを犠牲とする。
- 15:36 障害が緩和。更新されたインデックスが全クラスタにレプリケーションされた。
- 15:39 docbrownは最初のキャパシティの10倍となるインスタンス数の増加の第二波を開始。
- 15:41 jenniferはロードバランシングを再開し、全クラスタにトラフィックの1%を流した。
- 15:43 USA-2以外のクラスタのHTTP 500のレートは通常の状態。タスク障害は低レベルで間欠的に生じている状態。
- 15:45 jenniferはロードバランシングを調整し、USA-2以外のクラスタへのトラフィックを10%に引き上げ。
- 15:47 USA-2以外のクラスタのHTTP 500のレートは依然SLOの範囲内。タスクの障害は観測されていない。
- 15:50 USA-2以外のクラスタへのトラフィックを30%に引き上げ。
- 15:55 USA-2以外のクラスタへのトラフィックを50%に引き上げ。
- 16:00 障害は解消。すべてのトラフィックが全クラスタへ流される。
- 16:30 インシデントの終了。通常のパフォーマンスを30分間継続という終了基準を達成。
- モニタリングダッシュボード:http://monitor/shakespeare?end_time=20151021T160000&duration=7200

</details>


## 参考

- [SRE サイトリライアビリティエンジニアリング―Googleの信頼性を支えるエンジニアリングチーム/15 章 ポストモーテムの文化](https://www.oreilly.co.jp/books/9784873117911/)
    - [google/sre-book: Postmortem Culture: Learning from Failure](https://sre.google/sre-book/postmortem-culture/)
- [サイトリライアビリティワークブック―SREの実践方法/10章 ポストモーテムの文化：失敗からの学び](https://www.oreilly.co.jp/books/9784873119137/)
    - [google/workbook: Postmortem Culture: Learning from Failure](https://sre.google/workbook/postmortem-culture/)
- [PagerDuty Postmortems](https://postmortems.pagerduty.com/)

- [プロジェクトのポストモーテム会議を成功に導く 6 つのヒント](https://asana.com/ja/resources/project-post-mortem-tips)
